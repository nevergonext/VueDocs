---
title: ä»£ç†æ¨¡å¼
date: 2021-12-17 22:57:42
permalink: /pages/b4e029/
categories:
  - ã€ŠSpring5ã€‹ç¬”è®°
tags:
  - Spring5
author:
  name: Ashe
  link: https://github.com/asheone18
---
## ä»£ç†æ¨¡å¼

AOPçš„åº•å±‚æœºåˆ¶å°±æ˜¯åŠ¨æ€ä»£ç†

ä»£ç†æ¨¡å¼ï¼š

- é™æ€ä»£ç†

- åŠ¨æ€ä»£ç†

## é™æ€ä»£ç†

è§’è‰²åˆ†æï¼š

- æŠ½è±¡è§’è‰²ï¼šä¸€èˆ¬ä¼šä½¿ç”¨æ¥å£æˆ–è€…æŠ½è±¡ç±»æ¥è§£å†³
- çœŸå®è§’è‰²ï¼šè¢«ä»£ç†çš„è§’è‰²
- ä»£ç†è§’è‰²ï¼šä»£ç†çœŸå®è§’è‰²ï¼Œä»£ç†çœŸå®è§’è‰²åï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåšä¸€äº›é™„å±æ“ä½œ
- å®¢æˆ·ï¼šè®¿é—®ä»£ç†å¯¹è±¡çš„äºº

### å¥½å¤„ä¸å¼Šç«¯

å¥½å¤„: 

- å¯ä»¥ä½¿çœŸå®è§’è‰²çš„æ“ä½œæ›´åŠ çº¯ç²¹ï¼ä¸ç”¨å…³æ³¨ä¸€äº›å…¬å…±çš„ä¸šåŠ¡
- å…¬å…±äº‹æƒ…å°±äº¤ç»™ä»£ç†è§’è‰²ï¼å®ç°äº†ä¸šåŠ¡çš„åˆ†å·¥
- å…¬å…±ä¸šåŠ¡å‘ç”Ÿæ‰©å±•çš„æ—¶å€™ï¼Œæ–¹ä¾¿é›†ä¸­ç®¡ç†

ç¼ºç‚¹ï¼š

- ä¸€ä¸ªçœŸå®è§’è‰²å°±ä¼šäº§ç”Ÿä¸€ä¸ªä»£ç†è§’è‰²ï¼›ä»£ç é‡ä¼šç¿»å€ï½å¼€å‘æ•ˆç‡ä¼šå˜ä½
### å®ç°
1. æ¥å£
```java
//ç§Ÿæˆ¿æ¥å£
public interface Rent {
    public void rent();
}
```

2. çœŸå®è§’è‰²
```java
//æˆ¿ä¸œ
public class Host implements Rent {
    @Override
    public void rent(){
        System.out.println("æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­ï¼ğŸ ");
    }
}
```
3. ä»£ç†è§’è‰²
```java
public class Proxy implements Rent {
    private Host host;

    public Proxy() {
    }

    public Proxy(Host host) {
        this.host = host;
    }

    @Override
    public void rent() {
        seeHouse();
        host.rent();
        hetong();
        fare();
    }
    //çœ‹æˆ¿
    public void seeHouse(){
        System.out.println("ä¸­ä»‹å¸¦ä½ çœ‹æˆ¿");
    }

    //ç­¾ç½²åˆåŒ
    public void hetong(){
        System.out.println("ç­¾ç§ŸèµåˆåŒ");
    }

    //æ”¶å–ä¸­ä»‹è´¹
    public void fare(){
        System.out.println("æ”¶å–ä¸­ä»‹è´¹");
    }
}
```

4. å®¢æˆ·ç«¯è®¿é—®ä»£ç†è§’è‰²

```java
public class Client {
    public static void main(String[] args) {
        //æˆ¿ä¸œè¦ç§Ÿæˆ¿å­
        Host host = new Host();
        //ä»£ç†ï¼Œä¸­ä»‹å¸®æˆ¿ä¸œç§Ÿæˆ¿å­ï¼Œä½†æ˜¯ä»£ç†è§’è‰²ä¸€èˆ¬ä¼šæœ‰ä¸€äº›é™„å±æ“ä½œï¼
        Proxy proxy = new Proxy(host);
        //ä¸ç”¨é¢å¯¹æˆ¿ä¸œï¼Œç›´æ¥æ‰¾ä¸­ä»‹ç§Ÿæˆ¿å³å¯ï¼
        proxy.rent();
    }
}
```

## é™æ€ä»£ç†å†ç†è§£
åœ¨ä¸æ”¹å˜åŸæ¥çš„ä»£ç çš„æƒ…å†µä¸‹ï¼Œå®ç°äº†å¯¹åŸæœ‰åŠŸèƒ½çš„å¢å¼ºï¼Œè¿™æ˜¯AOPä¸­æœ€æ ¸å¿ƒçš„æ€æƒ³

### ä¾‹å­
1. åˆ›å»ºä¸€ä¸ªæŠ½è±¡è§’è‰²ï¼Œæ¯”å¦‚CRUD
```java
//æŠ½è±¡è§’è‰²ï¼šå¢åˆ æ”¹æŸ¥ä¸šåŠ¡
public interface UserService {
   void add();
   void delete();
   void update();
   void query();
}
```

2. éœ€è¦ä¸€ä¸ªçœŸå®å¯¹è±¡æ¥å®Œæˆè¿™äº›Crud
```java
//çœŸå®å¯¹è±¡ï¼Œå®Œæˆå¢åˆ æ”¹æŸ¥æ“ä½œçš„äºº
public class UserServiceImpl implements UserService {

   public void add() {
       System.out.println("å¢åŠ äº†ä¸€ä¸ªç”¨æˆ·");
  }

   public void delete() {
       System.out.println("åˆ é™¤äº†ä¸€ä¸ªç”¨æˆ·");
  }

   public void update() {
       System.out.println("æ›´æ–°äº†ä¸€ä¸ªç”¨æˆ·");
  }

   public void query() {
       System.out.println("æŸ¥è¯¢äº†ä¸€ä¸ªç”¨æˆ·");
  }
}
```

3. éœ€æ±‚æ¥äº†ï¼Œç°åœ¨éœ€è¦å¢åŠ ä¸€ä¸ªæ—¥å¿—åŠŸèƒ½

æ€è·¯1 ï¼šåœ¨å®ç°ç±»ä¸Šå¢åŠ ä»£ç  ã€éº»çƒ¦ã€‘

æ€è·¯2ï¼šä½¿ç”¨ä»£ç†æ¥åšï¼Œèƒ½å¤Ÿä¸æ”¹å˜åŸæ¥çš„ä¸šåŠ¡æƒ…å†µä¸‹ï¼Œå®ç°æ­¤åŠŸèƒ½å°±æ˜¯æœ€å¥½çš„äº†ï¼

4. è®¾ç½®ä¸€ä¸ªä»£ç†ç±»æ¥å¤„ç†æ—¥å¿—ï¼ä»£ç†è§’è‰²
```java
//ä»£ç†è§’è‰²ï¼Œåœ¨è¿™é‡Œé¢å¢åŠ æ—¥å¿—çš„å®ç°
public class UserServiceProxy implements UserService {
   private UserServiceImpl userService;

   public void setUserService(UserServiceImpl userService) {
       this.userService = userService;
  }

   public void add() {
       log("add");
       userService.add();
  }

   public void delete() {
       log("delete");
       userService.delete();
  }

   public void update() {
       log("update");
       userService.update();
  }

   public void query() {
       log("query");
       userService.query();
  }

   public void log(String msg){
       System.out.println("æ‰§è¡Œäº†"+msg+"æ–¹æ³•");
  }

}
```
5. æµ‹è¯•è®¿é—®ç±»
```java
public class Client {
   public static void main(String[] args) {
       //çœŸå®ä¸šåŠ¡
       UserServiceImpl userService = new UserServiceImpl();
       //ä»£ç†ç±»
       UserServiceProxy proxy = new UserServiceProxy();
       //ä½¿ç”¨ä»£ç†ç±»å®ç°æ—¥å¿—åŠŸèƒ½ï¼
       proxy.setUserService(userService);

       proxy.add();
  }
}
```

## èŠèŠAOP
![](../../.vuepress/public/ssm/spring05.png)

## åŠ¨æ€ä»£ç†

åŠ¨æ€ä»£ç†
åŠ¨æ€ä»£ç†çš„è§’è‰²å’Œé™æ€ä»£ç†çš„ä¸€æ · .

åŠ¨æ€ä»£ç†çš„ä»£ç†ç±»æ˜¯`åŠ¨æ€ç”Ÿæˆ`çš„ . é™æ€ä»£ç†çš„ä»£ç†ç±»æ˜¯`æå‰å†™å¥½`çš„

åŠ¨æ€ä»£ç†åˆ†ä¸ºä¸¤ç±» : ä¸€ç±»æ˜¯åŸºäº`æ¥å£`åŠ¨æ€ä»£ç† , ä¸€ç±»æ˜¯åŸºäº`ç±»`çš„åŠ¨æ€ä»£ç†

åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†----JDKåŠ¨æ€ä»£ç†

åŸºäºç±»çš„åŠ¨æ€ä»£ç†--cglib

ç°åœ¨ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯ `javasist` æ¥ç”ŸæˆåŠ¨æ€ä»£ç†

è¿™é‡Œä½¿ç”¨JDKçš„åŸç”Ÿä»£ç æ¥å®ç°ï¼Œå…¶ä½™çš„é“ç†éƒ½æ˜¯ä¸€æ ·çš„

JDKçš„åŠ¨æ€ä»£ç†éœ€è¦äº†è§£ä¸¤ä¸ªç±»

æ ¸å¿ƒ : `InvocationHandler`å’Œ`Proxy` 

### InvocationHandler

InvocationHandler: æ˜¯ç”±ä»£ç†å®ä¾‹çš„è°ƒç”¨å¤„ç†ç¨‹åºå®ç°çš„æ¥å£ï¼Œæ¯ä¸ªä»£ç†éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è°ƒç”¨å¤„ç†ç¨‹åºã€‚

```java
Object invoke(Object proxy, æ–¹æ³• method, Object[] args)ï¼›
```

- proxy: è°ƒç”¨è¯¥æ–¹æ³•çš„ä»£ç†å®ä¾‹
- method: æ‰€è¿°æ–¹æ³•å¯¹åº”äºè°ƒç”¨ä»£ç†å®ä¾‹ä¸Šçš„æ¥å£æ–¹æ³•çš„å®ä¾‹ã€‚æ–¹æ³•å¯¹è±¡çš„å£°æ˜ç±»å°†æ˜¯è¯¥æ–¹æ³•å£°æ˜çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ˜¯ä»£ç†ç±»ç»§æ‰¿è¯¥æ–¹æ³•çš„ä»£ç†æ¥å£çš„è¶…çº§æ¥å£
- args: åŒ…å«çš„æ–¹æ³•è°ƒç”¨ä¼ é€’ä»£ç†å®ä¾‹çš„å‚æ•°å€¼çš„å¯¹è±¡çš„é˜µåˆ—ï¼Œæˆ–nullå¦‚æœæ¥å£æ–¹æ³•æ²¡æœ‰å‚æ•°ã€‚åŸå§‹ç±»å‹çš„å‚æ•°åŒ…å«åœ¨é€‚å½“çš„åŸå§‹åŒ…è£…å™¨ç±»çš„å®ä¾‹ä¸­ï¼Œä¾‹å¦‚`java.lang.Integer`æˆ–`java.lang.Boolean` 

### Proxy  
Proxy: æä¾›äº†åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å’Œå®ä¾‹çš„é™æ€æ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯ç”±è¿™äº›æ–¹æ³•åˆ›å»ºçš„æ‰€æœ‰åŠ¨æ€ä»£ç†ç±»çš„è¶…ç±»
```java
//ç”Ÿæˆä»£ç†ç±»
public Object getProxy(){
   return Proxy.newProxyInstance(this.getClass().getClassLoader(),
                                 rent.getClass().getInterfaces(),
                                 this);
}
```

## å®ç°

1. æŠ½è±¡è§’è‰²
```java
//æŠ½è±¡è§’è‰²ï¼šç§Ÿæˆ¿
public interface Rent {
   public void rent();
}
```

2. çœŸå®è§’è‰²
```java
//çœŸå®è§’è‰²: æˆ¿ä¸œï¼Œæˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­
public class Host implements Rent{
   public void rent() {
       System.out.println("æˆ¿å±‹å‡ºç§Ÿ");
  }
} 
```

3. ä»£ç†è§’è‰²
```java
public class ProxyInvocationHandler implements InvocationHandler {
   private Rent rent;

   public void setRent(Rent rent) {
       this.rent = rent;
  }

   //ç”Ÿæˆä»£ç†ç±»ï¼Œé‡ç‚¹æ˜¯ç¬¬äºŒä¸ªå‚æ•°ï¼Œè·å–è¦ä»£ç†çš„æŠ½è±¡è§’è‰²ï¼ä¹‹å‰éƒ½æ˜¯ä¸€ä¸ªè§’è‰²ï¼Œç°åœ¨å¯ä»¥ä»£ç†ä¸€ç±»è§’è‰²
   public Object getProxy(){
       return Proxy.newProxyInstance(this.getClass().getClassLoader(),
               rent.getClass().getInterfaces(),this);
  }

   // proxy : ä»£ç†ç±» method : ä»£ç†ç±»çš„è°ƒç”¨å¤„ç†ç¨‹åºçš„æ–¹æ³•å¯¹è±¡.
   // å¤„ç†ä»£ç†å®ä¾‹ä¸Šçš„æ–¹æ³•è°ƒç”¨å¹¶è¿”å›ç»“æœ
   @Override
   public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
       seeHouse();
       //æ ¸å¿ƒï¼šæœ¬è´¨åˆ©ç”¨åå°„å®ç°ï¼
       Object result = method.invoke(rent, args);
       fare();
       return result;
  }

   //çœ‹æˆ¿
   public void seeHouse(){
       System.out.println("å¸¦æˆ¿å®¢çœ‹æˆ¿");
  }
   //æ”¶ä¸­ä»‹è´¹
   public void fare(){
       System.out.println("æ”¶ä¸­ä»‹è´¹");
  }

}
```

4. æµ‹è¯•
```java
//ç§Ÿå®¢
public class Client {

   public static void main(String[] args) {
       //çœŸå®è§’è‰²
       Host host = new Host();
       //ä»£ç†å®ä¾‹çš„è°ƒç”¨å¤„ç†ç¨‹åº
       ProxyInvocationHandler pih = new ProxyInvocationHandler();
       pih.setRent(host); //å°†çœŸå®è§’è‰²æ”¾ç½®è¿›å»ï¼
       Rent proxy = (Rent)pih.getProxy(); //åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„ä»£ç†ç±»ï¼
       proxy.rent();
  }

}
```

## ç†è§£
æ ¸å¿ƒ: ä¸€ä¸ªåŠ¨æ€ä»£ç† , ä¸€èˆ¬ä»£ç†æŸä¸€ç±»ä¸šåŠ¡ , ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯ä»¥ä»£ç†å¤šä¸ªç±»ï¼Œä»£ç†çš„æ˜¯æ¥å£

## é€šç”¨
ç¼–å†™ä¸€ä¸ªé€šç”¨çš„åŠ¨æ€ä»£ç†å®ç°çš„ç±»ï¼æ‰€æœ‰çš„ä»£ç†å¯¹è±¡è®¾ç½®ä¸ºObjectå³å¯
```java
public class ProxyInvocationHandler implements InvocationHandler {
   private Object target;

   public void setTarget(Object target) {
       this.target = target;
  }

   //ç”Ÿæˆä»£ç†ç±»
   public Object getProxy(){
       return Proxy.newProxyInstance(this.getClass().getClassLoader(),
               target.getClass().getInterfaces(),this);
  }

   // proxy : ä»£ç†ç±»
   // method : ä»£ç†ç±»çš„è°ƒç”¨å¤„ç†ç¨‹åºçš„æ–¹æ³•å¯¹è±¡.
   public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
       log(method.getName());
       Object result = method.invoke(target, args);
       return result;
  }

   public void log(String methodName){
       System.out.println("æ‰§è¡Œäº†"+methodName+"æ–¹æ³•");
  }

}
```
æµ‹è¯•

```java
public class Test {
   public static void main(String[] args) {
       //çœŸå®å¯¹è±¡
       UserServiceImpl userService = new UserServiceImpl();
       //ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åº
       ProxyInvocationHandler pih = new ProxyInvocationHandler();
       pih.setTarget(userService); //è®¾ç½®è¦ä»£ç†çš„å¯¹è±¡
       UserService proxy = (UserService)pih.getProxy(); //åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼
       proxy.delete();
  }
}
```

## å¥½å¤„
é™æ€ä»£ç†æœ‰çš„å®ƒéƒ½æœ‰ï¼Œé™æ€ä»£ç†æ²¡æœ‰çš„ï¼Œå®ƒä¹Ÿæœ‰

å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„çœŸå®è§’è‰²æ›´åŠ çº¯ç²¹ . ä¸å†å»å…³æ³¨ä¸€äº›å…¬å…±çš„äº‹æƒ… 

å…¬å…±çš„ä¸šåŠ¡ç”±ä»£ç†æ¥å®Œæˆ . å®ç°äº†ä¸šåŠ¡çš„åˆ†å·¥ 

å…¬å…±ä¸šåŠ¡å‘ç”Ÿæ‰©å±•æ—¶å˜å¾—æ›´åŠ é›†ä¸­å’Œæ–¹ä¾¿ 

ä¸€ä¸ªåŠ¨æ€ä»£ç† , ä¸€èˆ¬ä»£ç†æŸä¸€ç±»ä¸šåŠ¡

ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯ä»¥ä»£ç†å¤šä¸ªç±»ï¼Œä»£ç†çš„æ˜¯æ¥å£